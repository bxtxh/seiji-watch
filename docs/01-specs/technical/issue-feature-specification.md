# イシュー機能仕様書

**作成日**: 2025年7月11日  
**対象システム**: Diet Issue Tracker  
**バージョン**: 1.0  

## 1. 概要

### 1.1 イシュー機能の目的
国会で議論される**具体的な政策課題**を「イシュー」として管理・追跡し、関連する法案・議論・政治活動を集約して可視化する機能。

### 1.2 重要な概念区別

#### イシュー（Issue）
- **定義**: 具体的な政策課題・社会問題
- **例**: 
  - "介護・障害福祉従事者の人員確保"
  - "カーボンニュートラル目標達成のための制度整備"
  - "ライドシェア事業制度の導入"
  - "ギャンブル等依存症対策の強化"

#### 政策分野（Policy Category）
- **定義**: 法案・政策の分野分類（CAP準拠の階層システム）
- **例**:
  - L1: "社会保障", "環境・エネルギー", "経済・産業"
  - L2: "健康保険制度", "再生可能エネルギー", "交通政策"
  - L3: "高齢者医療", "太陽光発電", "公共交通"

#### 関係性
```
イシュー「介護人員確保」 → 政策分野「社会保障 > 介護・福祉 > 人材確保」
    ↓
関連法案「介護・障害福祉従事者の人材確保に関する特別措置法案」
```

## 2. データモデル仕様

### 2.1 Issue（イシュー）

```python
class Issue(BaseRecord):
    # 基本情報
    title: str                              # イシュー名（具体的な政策課題）
    description: str                        # 詳細説明
    priority: str = "medium"                # 優先度（high/medium/low）
    status: str = "active"                  # ステータス（active/reviewed/archived）
    
    # 関連エンティティ
    related_bills: Optional[List[str]]      # 関連法案レコードID
    issue_tags: Optional[List[str]]         # イシュータグレコードID
    policy_category_id: Optional[str]       # 政策分野カテゴリID（※名称変更）
    
    # AI・分析関連
    extraction_confidence: Optional[float]  # LLM抽出信頼度（0.0-1.0）
    review_notes: Optional[str]             # 管理者レビューノート
    is_llm_generated: bool = False          # AI自動生成フラグ
    
    # メタデータ
    created_at: str                         # 作成日時
    updated_at: str                         # 更新日時
```

### 2.2 PolicyCategory（政策分野）- CAP準拠階層システム

```python
class PolicyCategory(BaseRecord):
    # CAP分類情報
    cap_code: str                           # CAP分類コード（例: "13", "1305"）
    layer: str                              # 階層レベル（L1/L2/L3）
    title_ja: str                           # 日本語タイトル
    title_en: Optional[str]                 # 英語タイトル
    summary_150ja: Optional[str]            # 日本語説明（150文字以内）
    
    # 階層関係
    parent_category_id: Optional[str]       # 親カテゴリID
    
    # メタデータ
    is_seed: bool = False                   # CAP由来のシードデータフラグ
```

#### 階層例
```
L1: 13 "社会保障"
├── L2: 1301 "健康保険"
│   ├── L3: 130101 "国民健康保険制度"
│   └── L3: 130102 "高齢者医療制度"
├── L2: 1302 "介護・福祉"
│   ├── L3: 130201 "介護保険制度"
│   └── L3: 130202 "障害者福祉制度"
```

### 2.3 IssueTag（イシュータグ）

```python
class IssueTag(BaseRecord):
    name: str                               # タグ名（例: "長期審議", "緊急性高"）
    color_code: str = "#3B82F6"            # UI表示用カラーコード
    category: str                           # タグカテゴリ
    description: Optional[str]              # タグ説明
```

#### タグカテゴリ例
- **審議状況**: "長期審議", "短期審議", "継続審議"
- **緊急度**: "緊急性高", "緊急性中", "緊急性低"
- **影響範囲**: "全国影響", "地域限定", "特定業界"
- **審議特徴**: "与野党対立", "全会一致", "修正多数"

## 3. イシューワークフロー仕様

### 3.1 イシューライフサイクル

```
[発見・抽出] → [審議前] → [審議中] → [採決待ち] → [成立/廃案]
     ↓            ↓         ↓          ↓           ↓
  LLM抽出      タグ付け   委員会     審議完了     法案成立
  手動登録     分類       本会議     採決準備     廃案確定
```

### 3.2 ステージ定義

| ステージ | 説明 | 条件 |
|----------|------|------|
| **審議前** | イシューが特定されたが、関連法案の審議が開始されていない | 関連法案が提出済みだが審議未開始 |
| **審議中** | 関連法案が委員会・本会議で審議中 | 少なくとも1つの関連法案が審議中 |
| **採決待ち** | 審議完了し、採決予定が決定 | 審議完了、採決日程確定 |
| **成立** | 関連法案が可決成立または廃案確定 | 全関連法案の最終結果確定 |

### 3.3 ステージ判定ロジック
```python
def determine_issue_stage(issue: Issue, related_bills: List[Bill]) -> str:
    """関連法案の状態からイシューステージを判定"""
    
    if not related_bills:
        return "審議前"
    
    bill_statuses = [bill.status for bill in related_bills]
    
    # 1つでも成立/廃案があれば「成立」
    if any(status in ["passed", "enacted", "rejected"] for status in bill_statuses):
        return "成立"
    
    # 1つでも採決待ちがあれば「採決待ち」
    if any(status in ["pending_vote", "awaiting_vote"] for status in bill_statuses):
        return "採決待ち"
    
    # 1つでも審議中があれば「審議中」
    if any(status in ["under_review", "in_committee", "in_plenary"] for status in bill_statuses):
        return "審議中"
    
    # デフォルト
    return "審議前"
```

## 4. API仕様

### 4.1 実装済みエンドポイント

#### イシュー基本操作
- `GET /api/issues/` - イシュー一覧（フィルタリング対応）
- `POST /api/issues/` - 新規イシュー作成
- `PUT /api/issues/{issue_id}` - イシュー更新

#### AI機能
- `POST /api/issues/extract` - 法案内容からLLMでイシュー抽出

#### 政策分野・タグ
- `GET /api/issues/categories` - 政策分野階層一覧
- `GET /api/issues/tags/` - イシュータグ一覧

#### Kanban表示
- `GET /api/issues/kanban` - TOPページ用Kanbanデータ

### 4.2 未実装エンドポイント（必要）

#### 個別イシュー詳細
- `GET /api/issues/{issue_id}` - 個別イシュー詳細取得
- `GET /api/issues/{issue_id}/bills` - イシューの関連法案一覧

#### 詳細検索・分析
- `GET /api/issues/search` - 高度な検索機能
- `GET /api/issues/analytics` - イシュー分析データ

### 4.3 APIレスポンス例

#### GET /api/issues/{issue_id}
```json
{
  "success": true,
  "issue": {
    "id": "ISS-096",
    "title": "介護・障害福祉従事者の人員確保",
    "description": "介護・障害福祉分野における深刻な人材不足を解決するため...",
    "priority": "high",
    "status": "active",
    "stage": "審議中",
    "policy_category": {
      "id": "cat_130202",
      "cap_code": "1302",
      "layer": "L2",
      "title_ja": "介護・福祉",
      "parent_category": {
        "title_ja": "社会保障"
      }
    },
    "issue_tags": [
      {
        "id": "tag_001",
        "name": "長期審議",
        "color_code": "#F59E0B",
        "category": "審議期間",
        "description": "長期間にわたって審議されているイシュー"
      }
    ],
    "related_bills_count": 1,
    "extraction_confidence": 0.95,
    "is_llm_generated": true,
    "created_at": "2025-07-01T10:00:00Z",
    "updated_at": "2025-07-11T15:30:00Z"
  }
}
```

#### GET /api/issues/{issue_id}/bills
```json
{
  "success": true,
  "bills": [
    {
      "bill_id": "217-3",
      "title": "介護・障害福祉従事者の人材確保に関する特別措置法案",
      "summary": "介護・障害福祉従事者の人材確保に関する特別措置法案",
      "policy_category": {
        "id": "cat_社会保障",
        "title_ja": "社会保障",
        "layer": "L1"
      },
      "status": "under_review",
      "stage": "審議中",
      "bill_number": "217-3",
      "diet_url": "#",
      "relevance_score": 1.0,
      "relationship_type": "primary",
      "search_method": "direct"
    }
  ],
  "total_count": 1
}
```

## 5. UI/UX仕様

### 5.1 Kanbanボード（TOPページ）

#### レイアウト
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│   審議前    │   審議中    │  採決待ち   │    成立     │
│    (0件)    │    (8件)    │    (0件)    │    (8件)    │
├─────────────┼─────────────┼─────────────┼─────────────┤
│             │ [カード1]   │             │ [カード9]   │
│  空状態     │ [カード2]   │   空状態    │ [カード10]  │
│  メッセージ │ [カード3]   │  メッセージ │ [カード11]  │
│             │    ...      │             │    ...      │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

#### イシューカード仕様
```
┌────────────────────────────────────────┐
│ 🔸 介護・障害福祉従事者の人員確保...     │ ← イシュータイトル（20文字+...）
│ [審議中]                              │ ← ステージバッジ
│                                      │
│ 📅 2025年6月11日〜2025年7月11日       │ ← 審議期間
│                                      │
│ 📋 関連法案 1                         │ ← 関連法案数
│ └─ 217-37 [審議中]                   │ ← 法案番号・ステータス
│                                      │
│ 🏷️ 社会保障 長期審議                  │ ← タグ（最大3個）
│                                      │
│ 最終更新: 2025-07-11    詳細を見る → │ ← フッター
└────────────────────────────────────────┘
```

### 5.2 イシュー詳細ページ（/issues/[id]）

#### タブ構成
1. **概要タブ**: イシュー基本情報・政策分野・タグ
2. **関連法案タブ**: 関連法案一覧・進捗状況
3. **議論履歴タブ**: 関連する委員会・本会議の議論

#### 詳細表示項目
- **ヘッダー**: イシュー名、説明、優先度、ステータス
- **政策分野**: 階層表示（L1 > L2 > L3）
- **イシュータグ**: カラー付きタグ表示
- **関連法案**: 法案一覧、進捗状況、関連度スコア
- **メタデータ**: 作成日、更新日、AI生成フラグ、信頼度

## 6. LLM統合仕様

### 6.1 イシュー自動抽出

#### 入力
- **法案内容**: 法案の全文または要約
- **法案タイトル**: 法案の正式名称
- **既存イシューリスト**: 重複防止用

#### 処理フロー
```
法案内容 → LLM分析 → イシュー候補抽出 → 類似性チェック → 新規イシュー提案
                                    ↓
                            既存イシューとの関連付け
```

#### LLMプロンプト例
```
以下の法案内容から、具体的な政策課題（イシュー）を1-3個抽出してください。

【法案タイトル】: {bill_title}
【法案内容】: {bill_content}

【抽出条件】
- 具体的で実行可能な政策課題
- 20文字以内の簡潔なタイトル
- 社会的影響度の高いもの
- 既存イシューとの重複を避ける

【既存イシュー】: {existing_issues}

【出力形式】
{
  "issues": [
    {
      "title": "具体的なイシュー名",
      "description": "詳細説明（100文字以内）",
      "confidence": 0.95,
      "suggested_tags": ["タグ1", "タグ2"]
    }
  ]
}
```

### 6.2 政策分野自動分類

#### CAP-based分類
- **L1判定**: 法案内容から主要政策分野を判定
- **L2判定**: より具体的なサブカテゴリを判定
- **L3判定**: 最も具体的な政策領域を判定

## 7. データ整合性・品質管理

### 7.1 データ検証ルール

#### イシュー作成時
- タイトル: 1-100文字、日本語推奨
- 説明: 1-2000文字、具体的内容必須
- 政策分野: 有効なカテゴリIDのみ
- 関連法案: 存在する法案IDのみ

#### 関連性検証
- イシュー ⟷ 法案: 双方向関係の整合性
- イシュー ⟷ 政策分野: 階層構造の整合性
- 重複イシューの検出・統合

### 7.2 品質メトリクス
- **LLM抽出精度**: 人間レビューとの一致率 > 85%
- **関連性適切度**: 関連法案の妥当性スコア > 0.8
- **カテゴリ分類精度**: CAP分類の正確性 > 90%

## 8. パフォーマンス要件

### 8.1 API応答時間
- イシュー一覧取得: < 200ms
- 個別イシュー詳細: < 150ms
- Kanbanデータ生成: < 300ms
- LLMイシュー抽出: < 10秒

### 8.2 UI表示速度
- Kanbanボード初期表示: < 2秒
- イシューカードクリック→詳細表示: < 1秒
- タブ切り替え: < 500ms

## 9. セキュリティ・コンプライアンス

### 9.1 データアクセス制御
- **公開データ**: イシュー基本情報、関連法案
- **制限データ**: レビューノート、内部分析データ
- **管理者専用**: LLM信頼度、抽出ログ

### 9.2 政治的中立性
- イシューの客観的記述
- 政党・議員への偏向的表現禁止
- 政策評価の中立性維持

## 10. 今後の拡張予定

### 10.1 Phase 2 機能
- イシュー間の関連性分析
- 時系列での政策変遷追跡
- 議員の政策ポジション分析

### 10.2 Phase 3 機能
- 市民からのイシュー提案機能
- イシューの社会的インパクト測定
- 国際比較・ベンチマーキング

---

**文書管理**:
- 初版作成: 2025年7月11日
- 次回レビュー予定: 実装完了後
- 承認者: プロダクトオーナー